<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!--  This file has been downloaded from bootdey.com    @bootdey on twitter -->
    <!--  All snippets are MIT license http://bootdey.com/license -->

    <!--webpage icon-->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />

    <title>user profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="css/newsFeed.css" rel="stylesheet" />
    <link href="css/profile.css" rel="stylesheet" />
  </head>
  <body>
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <div class="container bootstrap snippets bootdey">
      <div class="row">
        <!-- Avatar Navigation-->
        <div class="profile-nav col-md-3">
          <div class="panel">
            <div class="user-heading round">
              <a href="#">
                <img src="images/avatar.png" alt="" />
              </a>
              <h1 id="fullName">Name Sirname</h1>
              <p id="email2">yourEmail@mailService.com</p>
            </div>

            <ul class="nav nav-pills nav-stacked">
              <li>
                <a href="main.html"> <i class="fa fa-home"></i> Αρχική </a>
              </li>
              <li class="active">
                <a href="userProfile.html">
                  <i class="fa fa-user"></i> Προφίλ</a
                >
              </li>
              <li>
                <a href="editProfile.html">
                  <i class="fa fa-edit"></i> Επεξεργασία Προφίλ</a
                >
              </li>
            </ul>
          </div>
        </div>

        <!-- Profile -->
        <div class="profile-info col-md-9">
          <!-- New Article -->

          <!-- Personal Info-->
          <div class="panel">
            <div class="bio-graph-heading" id="pData">Προσωπικά Στοιχεία</div>
            <div class="panel-body bio-graph-info">
              <div class="row form">
                <div class="bio-row">
                  <p><span>Όνομα:</span> <span id="name">Camila</span></p>
                  <p><span>Επίθετο: </span> <span id="sirname">Smith</span></p>
                  <p>
                    <span>Email: </span
                    ><span id="email">jsmith@flatlab.com</span>
                  </p>
                  <p>
                    <button class="pi" onclick="signOut();">Αποσύνδεση</button>
                  </p>
                </div>
                <div class="bio-row">
                  <form>
                    <input
                      class="editUser"
                      id="newName"
                      type="text"
                      placeholder="Νέο Ονόμα"
                    /><br />
                    <input
                      class="editUser"
                      id="newSurname"
                      type="text"
                      placeholder="Νέο Επίθετο"
                    /><br />
                    <input
                      id="newEmail"
                      class="editUser"
                      type="email"
                      placeholder="Νέο email"
                    /><br />
                    <p>
                      <button class="pi" onclick="updateuser();">Aλλαγή</button>
                    </p>
                    <br />
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- warnings -->

          <div
            class="alert alert-success collapsed alert-dismissible"
            role="alert"
            id="success"
          >
            <span id="responseSuccessMessage"></span>
            <button
              type="button"
              class="close"
              data-dismiss="alert"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div
            class="alert alert-danger collapsed alert-dismissible"
            role="alert"
            id="danger"
          >
            <span id="responseFailMessage"></span>
            <button
              type="button"
              class="close"
              data-dismiss="alert"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <!-- Previous Articles-->
          <div id="articlesContainer"></div>
        </div>
      </div>
    </div>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript"></script>

    <!--kimon-->
    <script>
      //gets usersArticles
      $(document).ready(function () {
        $("#danger").hide();
        $("#success").hide();
        getUsersArticles();
      });

      function getUsersArticles() {
        var uid = localStorage.getItem("userID");
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function () {
          if (this.readyState === 4) {
            if (this.status === 200) {
              console.log(event);
              console.log(JSON.parse(this.response));
              var response = JSON.parse(this.response);
              var prependContainer = $('<div class="row">');

              response.forEach(function (article) {
                $(`<div class="col-md-12">
                <div class="panel">
                  <div class="panel-body">
                    <div class="bio-chart">
                      <div class="articleTitle" style="display: inline; width: 100px; height: 100px;">
                        ${article.title}

                      </div>
                    </div>
                    <div class="bio-desk">
                      <article>
                        <p>
                          ${article.text}
                        </p>
                      </article>
                    </div>
                  </div>
                </div>
              </div>`).prependTo(prependContainer);
              });

              $("#articlesContainer").html(prependContainer);
            }
          }
        });

        xhr.open("GET", `http://127.0.0.1:5000/articles?uid=${uid}`);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.send();
      }

      $("#name").html(localStorage.getItem("username"));
      $("#sirname").html(localStorage.getItem("surname"));
      var fullName = getItem("username") + " " + getItem("surname");
      $("#fullName").html(fullName);

      $("#email").html(getItem("email"));
      $("#email2").html(getItem("email"));

      function getItem(name) {
        return localStorage.getItem(name);
      }

      function signOut() {
        localStorage.clear();
        window.location.href = "./login.html";
      }

      function updateuser() {
        var surname = $("#newSurname").val();
        var firstname = $("#newName").val();
        var email = $("#newEmail").val();
        var uid = localStorage.getItem("userID");
        var data = `uid=${uid}&surname=${surname}&name=${firstname}&email=${email}`;

        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function (event) {
          console.log("updateuser responce status: " + this.status);
          //if (this.readyState === 4) {
          if (this.status >= 200 && this.status < 400) {
            // console.log(event);
            // console.log(JSON.parse(this.response));
            var response = JSON.parse(this.response);
            $("#success").show();
            $("#responseSuccessMessage").html(response.response);
            storeUser(
              response.userID,
              response.username,
              response.surname,
              response.email
            );
            //window.location.href = "./userProfile.html";
          } else if (this.status === 400) {
            // console.log(event);
            // console.log(JSON.parse(this.response));
            var response = JSON.parse(this.response);
            $("#danger").show();
            $("#responseFailMessage").html(response.response);
          } else {
            var response = JSON.parse(this.response);
            console.log("unknown error. Code number: " + response);
          }
          // }
        });

        xhr.open("POST", "http://127.0.0.1:5000/updateuser");
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );

        xhr.send(data);
      }

      function checkField(fld) {
        var isRequired = $(fld).prop("required");
        var isValid = $(fld).prop("validity").valid;
        var isEmpty = $(fld).val() == "";
        $(fld).removeClass("is-valid").removeClass("is-invalid");
        if (isValid) {
          if (!isEmpty) $(fld).addClass("is-valid");
          return true;
        } else {
          $(fld).addClass("is-invalid");
          return false;
        }
      }

      function storeUser(userID, username, surname, email) {
        localStorage.setItem("userID", userID);
        localStorage.setItem("username", username);
        localStorage.setItem("surname", surname);
        localStorage.setItem("email", email);
      }
    </script>
  </body>
</html>
